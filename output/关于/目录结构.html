<!DOCTYPE HTML>
<html>
    <head>
        <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
        <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
        <title>目录结构 - </title>
        <meta name="keywords" content=""/>
        <meta name="description" content=""/>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body>
        <div id="container">
            
<div id="header">
  <div id="post-nav"><a href="/">Home</a>&nbsp;»&nbsp;<a href="/#关于">关于</a>&nbsp;»&nbsp;目录结构</div>
</div>
<div class="clearfix"></div>
<div id="title">目录结构</div>
  <div id="content">
  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#client">client(客户端代码)</a><ul>
<li><a href="#css">css(全局样式)</a><ul>
<li><a href="#fontawesomeicon-font">fontAwesome(icon-font的辅助样式)</a></li>
<li><a href="#globals">globals(全局的样式)</a></li>
<li><a href="#util">util(样式辅助工具)</a></li>
<li><a href="#mainlessless">main.less(引用所需的less文件)</a></li>
</ul>
</li>
<li><a href="#lib">lib(前台公用代码)</a><ul>
<li><a href="#commoncoffee">common.coffee(前台公共函数)</a><ul>
<li><a href="#_1">时间操作</a><ul>
<li><a href="#switchdatetype-string-back-boolean">switchDate(type: String, back: Boolean)</a></li>
<li><a href="#setcutimedata">setCuTime(data)</a></li>
<li><a href="#gotoday">goToday()</a></li>
<li><a href="#createmonth">createMonth()</a></li>
<li><a href="#filterbyhourcollection-date">filterByHour(collection, date)</a></li>
</ul>
</li>
<li><a href="#_2">页面效果</a><ul>
<li><a href="#showmodaltemplatename-data-dom-">showModal(templateName, data, dom)   ---  重要!</a></li>
</ul>
</li>
<li><a href="#_3">数据相关</a><ul>
<li><a href="#allsharemember">allShareMember()</a></li>
</ul>
</li>
<li><a href="#_4">订阅操作</a><ul>
<li><a href="#subfriendinfo">subfriendInfo()</a></li>
<li><a href="#refreshsubname">refreshSub(name)</a></li>
<li><a href="#subnotificationnamearr">subNotificationName(arr)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#registerhelpercoffeehelper">registerHelper.coffee(全局的helper方法)</a><ul>
<li><a href="#readavatar-id">{{readAvatar id}}</a></li>
<li><a href="#getnotifyname-obj">{{getNotifyName obj}}</a></li>
</ul>
</li>
<li><a href="#settingcoffee">setting.coffee(前台第三方的插件设置)</a></li>
</ul>
</li>
<li><a href="#view">view(视图代码)</a><ul>
<li><a href="#auth">auth(登陆注册)</a><ul>
<li><a href="#auth-joincoffee">auth-join.coffee</a></li>
<li><a href="#auth-joinhtml">auth-join.html</a></li>
<li><a href="#auth-signinhtml">auth-signin.html</a></li>
<li><a href="#auth-signinjs">auth-signin.js</a></li>
<li><a href="#authimportless">auth.import.less</a></li>
</ul>
</li>
<li><a href="#calendar">calendar(日历主文件)</a><ul>
<li><a href="#calendar-detailcoffee">calendar-detail.coffee</a></li>
<li><a href="#calendar-detailhtml">calendar-detail.html</a></li>
<li><a href="#calendar-itemhtml">calendar-item.html</a></li>
<li><a href="#calendar-itemimportcss">calendar-item.import.css</a></li>
<li><a href="#calendarimportless">calendar.import.less</a></li>
<li><a href="#date-itemcoffee">date-item.coffee</a></li>
<li><a href="#day-viewcofeee">day-view.cofeee</a></li>
<li><a href="#month-viewcoffee">month-view.coffee</a></li>
<li><a href="#today-viewcoffee">today-view.coffee</a></li>
<li><a href="#week-viewcoffee">week-view.coffee</a></li>
</ul>
</li>
<li><a href="#group">group(好友群组)</a><ul>
<li><a href="#groupcoffee">group.coffee</a></li>
<li><a href="#grouphtml">group.html</a></li>
<li><a href="#groupimportless">group.import.less</a></li>
</ul>
</li>
<li><a href="#header">header(头部)</a><ul>
<li><a href="#headercoffee">header.coffee</a></li>
<li><a href="#headerhtml">header.html</a></li>
</ul>
</li>
<li><a href="#modal">modal(模态框)</a><ul>
<li><a href="#add-groupcoffee">add-group.coffee</a></li>
<li><a href="#add-grouphtml">add-group.html</a></li>
<li><a href="#add-personcoffee">add-person.coffee</a></li>
<li><a href="#add-personhtml">add-person.html</a></li>
<li><a href="#modalcoffee">modal.coffee</a></li>
<li><a href="#modalhtml">modal.html</a></li>
<li><a href="#modalimportless">modal.import.less</a></li>
</ul>
</li>
<li><a href="#share">share(分享)</a><ul>
<li><a href="#sharecoffee">share.coffee</a></li>
<li><a href="#sharehtml">share.html</a></li>
<li><a href="#shareimportless">share.import.less</a></li>
</ul>
</li>
<li><a href="#sidebar">sidebar(侧栏)</a><ul>
<li><a href="#sidebarcoffee">sidebar.coffee</a></li>
<li><a href="#sidebarhtml">sidebar.html</a></li>
</ul>
</li>
<li><a href="#tooltemplateloading404">toolTemplate(loading和404)</a></li>
<li><a href="#app-bodyhtmllayout">app-body.html(layout模板)</a></li>
<li><a href="#app-bodyjs">app-body.js(没啥用)</a></li>
</ul>
</li>
<li><a href="#headhtml">head.html(头文件)</a></li>
</ul>
</li>
<li><a href="#lib_1">lib(前后台公用代码)</a><ul>
<li><a href="#collection">collection(表)</a><ul>
<li><a href="#db-calendarcoffee">DB-calendar.coffee</a><ul>
<li><a href="#_5">查询方法</a></li>
<li><a href="#_6">修改方法</a></li>
<li><a href="#_7">表权限</a></li>
</ul>
</li>
<li><a href="#db-friendcoffee">DB-friend.coffee</a><ul>
<li><a href="#_8">表权限</a></li>
<li><a href="#_9">添加好友的方法</a></li>
</ul>
</li>
<li><a href="#db-groupcoffee">DB-group.coffee</a><ul>
<li><a href="#_10">表权限</a></li>
<li><a href="#_11">查询方法</a></li>
<li><a href="#_12">操作方法</a></li>
</ul>
</li>
<li><a href="#db-initcoffee">DB-init.coffee</a></li>
<li><a href="#db-notificationcoffee">DB-notification.coffee</a><ul>
<li><a href="#_13">表权限</a></li>
<li><a href="#notification">notification的设计标准</a></li>
<li><a href="#notification_1">notification的相关方法</a></li>
</ul>
</li>
<li><a href="#db-usercoffee">DB-user.coffee</a><ul>
<li><a href="#_14">表权限</a></li>
<li><a href="#_15">辅助函数</a></li>
<li><a href="#_16">人员操作</a></li>
<li><a href="#_17">共享操作</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#router">router(路由)</a><ul>
<li><a href="#initroutercoffee">initRouter.coffee</a></li>
<li><a href="#routercoffee">router.coffee</a></li>
</ul>
</li>
<li><a href="#basecoffee">base.coffee(初始化的命名空间定义)</a></li>
</ul>
</li>
<li><a href="#public">public(静态资源)</a><ul>
<li><a href="#fonts">fonts(字体文件)</a></li>
<li><a href="#img">img(图片资源)</a></li>
</ul>
</li>
<li><a href="#server">server(后台代码)</a><ul>
<li><a href="#accounts-helpercoffee">accounts-helper.coffee(登陆的辅助方法)</a></li>
<li><a href="#membercoffee">member.coffee(成员的后台方法)</a></li>
<li><a href="#publishcoffee">publish.coffee(发布逻辑)</a></li>
</ul>
</li>
</ul>
</div>
<p>介绍微度日历的目录结构</p>
<h1 id="client">client(客户端代码)</h1>
<h2 id="css">css(全局样式)</h2>
<h3 id="fontawesomeicon-font">fontAwesome(icon-font的辅助样式)</h3>
<h3 id="globals">globals(全局的样式)</h3>
<div class="hlcode"><pre><span class="o">-</span> <span class="n">base</span><span class="p">.</span><span class="n">import</span><span class="p">.</span><span class="n">less</span>              <span class="err">清除默认样式</span>
<span class="o">-</span> <span class="n">list</span><span class="o">-</span><span class="n">items</span><span class="p">.</span><span class="n">import</span><span class="p">.</span><span class="n">less</span>                    
<span class="o">-</span> <span class="n">button</span><span class="p">.</span><span class="n">import</span><span class="p">.</span><span class="n">less</span>            <span class="err">按钮的样式</span>
<span class="o">-</span> <span class="n">menu</span><span class="p">.</span><span class="n">import</span><span class="p">.</span><span class="n">less</span>
<span class="o">-</span> <span class="n">form</span><span class="p">.</span><span class="n">import</span><span class="p">.</span><span class="n">less</span>        
<span class="o">-</span> <span class="n">message</span><span class="p">.</span><span class="n">import</span><span class="p">.</span><span class="n">less</span>
<span class="o">-</span> <span class="n">header</span><span class="p">.</span><span class="n">import</span><span class="p">.</span><span class="n">less</span>            <span class="n">header</span><span class="err">头的样式</span>
<span class="o">-</span> <span class="n">nav</span><span class="p">.</span><span class="n">import</span><span class="p">.</span><span class="n">less</span>
<span class="o">-</span> <span class="n">layout</span><span class="p">.</span><span class="n">import</span><span class="p">.</span><span class="n">less</span>      
<span class="o">-</span> <span class="n">notification</span><span class="p">.</span><span class="n">import</span><span class="p">.</span><span class="n">less</span>      <span class="err">通知的样式</span>
<span class="o">-</span> <span class="n">link</span><span class="p">.</span><span class="n">import</span><span class="p">.</span><span class="n">less</span>        
<span class="o">-</span> <span class="n">sidebar</span><span class="p">.</span><span class="n">import</span><span class="p">.</span><span class="n">less</span> 
</pre></div>


<h3 id="util">util(样式辅助工具)</h3>
<div class="hlcode"><pre><span class="o">-</span> <span class="n">helpers</span><span class="p">.</span><span class="n">import</span><span class="p">.</span><span class="n">less</span>           <span class="err">一些全局的辅助样式，值得注意的为</span><span class="p">.</span><span class="n">position</span>
<span class="o">-</span> <span class="n">reset</span><span class="p">.</span><span class="n">import</span><span class="p">.</span><span class="n">less</span>     
<span class="o">-</span> <span class="n">typography</span><span class="p">.</span><span class="n">import</span><span class="p">.</span><span class="n">less</span>
<span class="o">-</span> <span class="n">lesshat</span><span class="p">.</span><span class="n">import</span><span class="p">.</span><span class="n">less</span>                       <span class="err">自动加前缀的工具，遇到兼容性问题就进来查，比较重要的文件</span>
<span class="o">-</span> <span class="n">text</span><span class="p">.</span><span class="n">import</span><span class="p">.</span><span class="n">less</span>    
<span class="o">-</span> <span class="n">variables</span><span class="p">.</span><span class="n">import</span><span class="p">.</span><span class="n">less</span>         <span class="err">所有的变量，尽量不要在零散的</span><span class="n">css</span><span class="err">里面写颜色和数值，后期不好修改，请把所有公共的变量写入这个文件，十分重要！！！！</span>
</pre></div>


<h3 id="mainlessless">main.less(引用所需的less文件)</h3>
<p>如果有新的less文件记得引入进来，否则是不起作用的，用法为<code>@import 'globals/base.import.less'</code></p>
<h2 id="lib">lib(前台公用代码)</h2>
<h3 id="commoncoffee">common.coffee(前台公共函数)</h3>
<p>声明了<code>Common.client</code>命名空间,前台的公共函数全部存储到其中</p>
<p><code>Common.client.static</code>为静态资源的命名空间</p>
<h4 id="_1">时间操作</h4>
<h5 id="switchdatetype-string-back-boolean">switchDate(type: String, back: Boolean)</h5>
<div class="hlcode"><pre><span class="err">参数</span><span class="o">:</span> <span class="n">type</span><span class="err">值为</span><span class="p">[</span><span class="err">&#39;</span><span class="n">days</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">weeks</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">months</span><span class="err">&#39;</span><span class="p">],</span><span class="n">back</span><span class="err">为</span><span class="nb">true</span><span class="err">时</span><span class="p">,</span><span class="err">为后退</span>
<span class="err">功能</span><span class="o">:</span><span class="err">切换日期的时间函数</span><span class="p">,</span><span class="err">例如在切换上一月下一月</span><span class="p">,</span><span class="err">前一天后一天</span>
<span class="err">原理</span><span class="o">:</span><span class="err">通过</span><span class="n">moment</span><span class="p">.</span><span class="n">js</span><span class="err">做日期的增减操作</span><span class="p">,</span><span class="err">然后操作</span><span class="n">Session</span>
</pre></div>


<h5 id="setcutimedata">setCuTime(data)</h5>
<div class="hlcode"><pre><span class="err">参数</span><span class="o">:</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">year</span><span class="p">,</span>
    <span class="n">month</span><span class="p">,</span>
    <span class="n">date</span>
<span class="p">}</span>
<span class="err">功能</span><span class="o">:</span><span class="err">设置当前时间</span>
<span class="err">原理</span><span class="o">:</span><span class="err">通过控制</span><span class="n">Session</span><span class="err">切换当前时间</span>
</pre></div>


<h5 id="gotoday">goToday()</h5>
<p><code>跳转到当前系统时间</code></p>
<h5 id="createmonth">createMonth()</h5>
<p><code>生成当月的数据,主要使用在月视图</code></p>
<h5 id="filterbyhourcollection-date">filterByHour(collection, date)</h5>
<div class="hlcode"><pre><span class="err">参数</span><span class="o">:</span> <span class="n">collection</span><span class="err">为数组</span><span class="p">,</span><span class="err">从数据库中查询后</span><span class="n">fetch</span><span class="err">的数据</span>
     <span class="n">date</span> <span class="o">=</span> <span class="p">{</span>
     <span class="nl">year:</span> <span class="n">Number</span>
     <span class="nl">month:</span> <span class="n">Number</span>
     <span class="nl">date:</span> <span class="n">Number</span>
     <span class="nl">hour:</span> <span class="n">Number</span>
<span class="p">}</span>
<span class="err">功能</span><span class="o">:</span> <span class="err">根据起始时间筛选数据</span><span class="p">,</span><span class="err">主要使用在计算待办事项</span>
</pre></div>


<h4 id="_2">页面效果</h4>
<h5 id="showmodaltemplatename-data-dom-">showModal(templateName, data, dom)   ---  重要!</h5>
<div class="hlcode"><pre><span class="err">参数</span><span class="o">:</span> <span class="n">templateName</span><span class="err">弹出层的模板名</span><span class="p">,</span> <span class="n">data</span><span class="err">为渲染弹出层的数据</span><span class="p">,</span> <span class="n">dom</span><span class="err">为插入的地方</span><span class="p">,</span><span class="err">默认是</span><span class="n">body</span>
<span class="err">功能</span><span class="o">:</span> <span class="err">删除前一个弹出层</span><span class="p">,</span><span class="err">并新渲染一个弹出层</span><span class="p">,</span><span class="err">避免同时存在的弹出层太多</span><span class="p">,</span><span class="err">不好管理的问题</span><span class="p">,</span><span class="err">请使用新弹出层的时候以这个方法来插入</span>
</pre></div>


<h4 id="_3">数据相关</h4>
<h5 id="allsharemember">allShareMember()</h5>
<p><code>在弹出层中计算出当前能分享的人和群组,用于新建日程和修改日程</code></p>
<h4 id="_4">订阅操作</h4>
<h5 id="subfriendinfo">subfriendInfo()</h5>
<p><code>再次订阅friendInfo数据,原因是因为Meteor.users不是活性数据</code></p>
<h5 id="refreshsubname">refreshSub(name)</h5>
<p><code>刷新订阅数据</code></p>
<h5 id="subnotificationnamearr">subNotificationName(arr)</h5>
<p><code>根据消息id来订阅回消息的描述</code></p>
<h3 id="registerhelpercoffeehelper">registerHelper.coffee(全局的helper方法)</h3>
<h4 id="readavatar-id">{{readAvatar id}}</h4>
<div class="hlcode"><pre><span class="err">参数</span><span class="o">:</span> <span class="err">用户</span><span class="n">id</span>
<span class="err">功能</span><span class="o">:</span> <span class="err">返回用户的头像</span>
<span class="err">原理</span><span class="o">:</span> <span class="err">查用户的</span><span class="n">icon</span><span class="err">字段</span><span class="p">,</span><span class="err">如果是二进制的就返回</span><span class="p">,</span><span class="err">如果不是就去线上读</span>
</pre></div>


<h4 id="getnotifyname-obj">{{getNotifyName obj}}</h4>
<div class="hlcode"><pre><span class="err">参数</span><span class="o">:</span> <span class="n">obj</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nl">operate_id:</span> <span class="n">String</span>
    <span class="nl">target_id:</span> <span class="n">String</span>
    <span class="nl">event_type:</span> <span class="n">String</span>
<span class="p">}</span>
<span class="err">功能</span><span class="o">:</span> <span class="err">根据消息的信息组合出消息的内容</span>
</pre></div>


<h3 id="settingcoffee">setting.coffee(前台第三方的插件设置)</h3>
<p>第三方弹出框的设置</p>
<div class="hlcode"><pre><span class="nl">effect:</span>    <span class="err">动画类型</span>
<span class="nl">position:</span>  <span class="err">出现的位置</span>
<span class="nl">timeout:</span>   <span class="err">出现的时间</span>
</pre></div>


<h2 id="view">view(视图代码)</h2>
<h3 id="auth">auth(登陆注册)</h3>
<h4 id="auth-joincoffee">auth-join.coffee</h4>
<blockquote>
<p>注册的js文件，后期需要调整的也就是<code>Template.join.events</code>里面的两个事件了</p>
<p><strong>这里需要注意的是，如果登陆有错误信息，请写入<code>Session.set(ERRORS_KEY, value)</code></strong></p>
<p><strong>注册发验证码仍为未完成状态，请完善</strong></p>
</blockquote>
<h4 id="auth-joinhtml">auth-join.html</h4>
<blockquote>
<p>注册的页面文件，没什么需要改动的</p>
</blockquote>
<h4 id="auth-signinhtml">auth-signin.html</h4>
<blockquote>
<p>登陆的页面，没什么好需要改动的地方</p>
</blockquote>
<h4 id="auth-signinjs">auth-signin.js</h4>
<blockquote>
<p>登陆的js文件</p>
</blockquote>
<h4 id="authimportless">auth.import.less</h4>
<blockquote>
<p>登陆注册的样式文件</p>
</blockquote>
<h3 id="calendar">calendar(日历主文件)</h3>
<h4 id="calendar-detailcoffee">calendar-detail.coffee</h4>
<blockquote>
<p>日历版块的一些小事件，不太重要，主要功能有右侧迷你日历的一些事件，还有中间顶部选项卡的事件</p>
<p>需要注意的是<code>Common.client.switchDate</code>函数,第一个参数是需要变换的类型,第二个是增还是减</p>
</blockquote>
<h4 id="calendar-detailhtml">calendar-detail.html</h4>
<blockquote>
<p>日历部分主视图，主要是框架模板</p>
</blockquote>
<h4 id="calendar-itemhtml">calendar-item.html</h4>
<blockquote>
<p>包含：</p>
<ol>
<li>
<p>今天的模板</p>
</li>
<li>
<p>日视图模板</p>
</li>
<li>
<p>周视图模板</p>
</li>
<li>
<p>月视图模板</p>
</li>
<li>
<p>每一条日程的模板</p>
</li>
</ol>
</blockquote>
<h4 id="calendar-itemimportcss">calendar-item.import.css</h4>
<blockquote>
<p>以上5个模板的样式</p>
</blockquote>
<h4 id="calendarimportless">calendar.import.less</h4>
<blockquote>
<p>主要是calendar-detail.html的样式</p>
</blockquote>
<h4 id="date-itemcoffee">date-item.coffee</h4>
<blockquote>
<p>日程的逻辑，需要注意的是rendered和onDestroyed方法，</p>
<p>rendered里面是新建日个日程然后计算该时段有的日程数，做width和left的重新赋值</p>
<p>onDestroyed方法是删除一个日程的时候，重新计算该时段width和left的方法</p>
<p>具体细节请看注释</p>
</blockquote>
<h4 id="day-viewcofeee">day-view.cofeee</h4>
<blockquote>
<p>日视图的操作逻辑，需要注意的是<code>helpers</code>里面有个<code>hours</code>，这个的逻辑是,先找出一个人今天的任务(DB.Calendar.findByDate方法),然后根据小时去筛选(Common.client.filterByHour方法)</p>
<p>点击一个时段的方法中,<code>Common.client.showModal</code>是显示模态框的方法</p>
</blockquote>
<h4 id="month-viewcoffee">month-view.coffee</h4>
<blockquote>
<p>月视图的操作逻辑,需要注意的是<code>Common.client.createMonth()</code>方法,这个和小日历里面的显示逻辑是公用的,具体详情请看方法代码</p>
<p>'click .month-cal td'这个方法需要注意,这里是点击某一天,因为在共享模板里面是复用月视图模板的,所以这里针对路由做了判断处理</p>
</blockquote>
<h4 id="today-viewcoffee">today-view.coffee</h4>
<blockquote>
<p>今天视图的模板,需要注意的只有,<code>DB.Calendar.findNearlyDate</code>函数,第一个参数是类型,第二个是筛选出来的最大条数,默认5条</p>
</blockquote>
<h4 id="week-viewcoffee">week-view.coffee</h4>
<blockquote>
<p>周视图模板,大多数代码和日视图相同,逻辑复杂的地方主要是有<code>helper</code>中的<code>hours</code>,第一层循环是时间,但是因为每天的数据是一样的,所以我就把每天的时段存储在一个缓存变量中,这样就第一次处理的时候需要从数据库读取数据筛选,之后的时段就不需要了,这里有个coffee的用法就是</p>
</blockquote>
<div class="hlcode"><pre><span class="nx">arr</span> <span class="o">=</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
    <span class="p">{</span>
    <span class="nx">a</span><span class="o">:</span> <span class="nx">i</span>
<span class="p">}</span>
</pre></div>


<blockquote>
<p>这种写法的类似</p>
</blockquote>
<div class="hlcode"><pre><span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">arr</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">a</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">][</span><span class="nx">i</span><span class="p">]});</span>
<span class="p">}</span>
</pre></div>


<h3 id="group">group(好友群组)</h3>
<h4 id="groupcoffee">group.coffee</h4>
<blockquote>
<p>群组页面的操作逻辑,需要注意的是,<code>Template.group.helpers</code>里面的<code>members</code>,这个地方用<code>transform</code>做了一下处理,筛选出了没同意的,和已经被拒绝的,注意,使用<code>transform</code>方法请在后面记得加上<code>.fetch()</code></p>
<p>第二个值得注意的方法是<code>Template.friendInfo.helpers</code>中的<code>commonCal</code>,这个是计算和目标人员的共同任务用的</p>
</blockquote>
<h4 id="grouphtml">group.html</h4>
<blockquote>
<p>群组模板</p>
</blockquote>
<h4 id="groupimportless">group.import.less</h4>
<blockquote>
<p>群组模板的样式</p>
</blockquote>
<h3 id="header">header(头部)</h3>
<h4 id="headercoffee">header.coffee</h4>
<blockquote>
<p>头部状态了的逻辑,需要注意的是,这里包含了<code>Notification</code>的逻辑,<code>DB.Notification.eventType[eventType]</code>中,根据<code>dom</code>上的<code>data-event</code>字段来判断使用哪个方法,<code>DB.Notification</code>定义在<code>lib/collection/DB-notification.coffee</code>中</p>
</blockquote>
<h4 id="headerhtml">header.html</h4>
<blockquote>
<p>头部状态栏的dom结构</p>
</blockquote>
<h3 id="modal">modal(模态框)</h3>
<h4 id="add-groupcoffee">add-group.coffee</h4>
<blockquote>
<p>添加群组的逻辑,这里需要注意的有:</p>
<ol>
<li>
<p><code>Schemas.addGroup</code>是创建了一个数据模型,调用了第三方的<code>autoform</code>插件,及其好用,具体请前往<code>atmosphere</code>上查看具体情况</p>
</li>
<li>
<p>添加群组是调用<code>DB.Groups.addGroup</code>方法</p>
</li>
<li>
<p>修改群组信息是<code>DB.Groups.updateMemberList</code>方法,退出群组就是变相的修改群组</p>
</li>
</ol>
</blockquote>
<h4 id="add-grouphtml">add-group.html</h4>
<blockquote>
<p>群组相关的模态框模板</p>
</blockquote>
<h4 id="add-personcoffee">add-person.coffee</h4>
<blockquote>
<p>添加联系人的操作逻辑,需要注意:</p>
<ol>
<li>
<p><code>Meteor.call('findPerson')</code>方法,因为数据是在后台,没有抛到前台来,所以得在后台定义方法,前台调用</p>
</li>
<li>
<p><code>click #modalConfirm</code>方法,如果是邀请人员没有补充</p>
</li>
<li>
<p><code>DB.Friend.sendQueryAddPerson</code>申请添加好友的函数</p>
</li>
</ol>
</blockquote>
<h4 id="add-personhtml">add-person.html</h4>
<blockquote>
<p>添加联系人的模态框模板</p>
</blockquote>
<h4 id="modalcoffee">modal.coffee</h4>
<blockquote>
<p>包含三个模板的操作逻辑: 添加日程,修改日程,个人设置</p>
<p>需要注意</p>
<ol>
<li>
<p>定义了一个schema,包含了一个日程的数据模型,使用auto-form自动生成表单</p>
</li>
<li>
<p>添加日程的时候过程麻烦,逻辑不麻烦,修改也是一样</p>
</li>
<li>
<p>注意rendered方法,主要是用来获取点击的时候的数据的,因为我的模态框每次点击都是先删除再添加,所以每次都会触发rendered事件</p>
</li>
<li>
<p>个人设置中,上传头像用的方法是解析成二进制文件,然后存储在数据库中</p>
</li>
</ol>
</blockquote>
<h4 id="modalhtml">modal.html</h4>
<blockquote>
<p>包含三个模块:添加日程,修改日程,个人设置</p>
</blockquote>
<h4 id="modalimportless">modal.import.less</h4>
<blockquote>
<p>所有模态框的样式</p>
</blockquote>
<h3 id="share">share(分享)</h3>
<h4 id="sharecoffee">share.coffee</h4>
<blockquote>
<p>分享部分的模板,这里的members算的时候,是只算出了分享给你日历的人</p>
</blockquote>
<h4 id="sharehtml">share.html</h4>
<blockquote>
<p>分享部分的模板</p>
</blockquote>
<h4 id="shareimportless">share.import.less</h4>
<blockquote>
<p>分享部分的所有样式</p>
</blockquote>
<h3 id="sidebar">sidebar(侧栏)</h3>
<h4 id="sidebarcoffee">sidebar.coffee</h4>
<blockquote>
<p>就一个选项卡</p>
</blockquote>
<h4 id="sidebarhtml">sidebar.html</h4>
<blockquote>
<p>侧栏的模板</p>
</blockquote>
<h3 id="tooltemplateloading404">toolTemplate(loading和404)</h3>
<p>这里面都是todolist留下来的</p>
<h3 id="app-bodyhtmllayout">app-body.html(layout模板)</h3>
<p>yield模板</p>
<h3 id="app-bodyjs">app-body.js(没啥用)</h3>
<h2 id="headhtml">head.html(头文件)</h2>
<h1 id="lib_1">lib(前后台公用代码)</h1>
<h2 id="collection">collection(表)</h2>
<p>注意: 尽量把所有表的操作,都离散成小的功能,然后在表的实例上添加该方法,不要在逻辑区域添加修改数据库的函数,这样不方便以后更改</p>
<h3 id="db-calendarcoffee">DB-calendar.coffee</h3>
<blockquote>
<p>定义了DB.Calendar表,并为这个表的实例添加了一些方法</p>
</blockquote>
<h4 id="_5">查询方法</h4>
<p>findByDate(userId: String, date: Object)</p>
<div class="hlcode"><pre><span class="err">参数</span><span class="o">:</span> <span class="n">userId</span><span class="err">是目标用户的</span><span class="n">id</span><span class="p">,</span><span class="n">date</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nl">year:</span> <span class="n">Number</span>
    <span class="nl">month:</span> <span class="n">Number</span>
    <span class="nl">date:</span> <span class="n">Number</span>
<span class="p">}</span>
<span class="err">功能</span><span class="o">:</span> <span class="err">算出某人当天的所有日程</span>
</pre></div>


<p>findNearlyToDo(limitNum: Number)</p>
<div class="hlcode"><pre><span class="err">参数</span><span class="o">:</span> <span class="n">limitNum</span><span class="err">是限制的数目</span>
<span class="err">功能</span><span class="o">:</span> <span class="err">找最近代办的日程</span>
</pre></div>


<p>findNearlyCom(limitNum: Number)</p>
<div class="hlcode"><pre><span class="err">找到最近已经完成的日程</span><span class="p">(</span><span class="err">注意</span><span class="p">,</span><span class="err">这里没通过时间去找</span><span class="p">,</span><span class="err">而是找到所有完成的任务然后通过排序取了最新的几条</span><span class="p">)</span>
</pre></div>


<p>findShareDate(limitNum: Number)</p>
<div class="hlcode"><pre><span class="err">找到最近分享给别人的日程</span>
</pre></div>


<p>findBeShareDate(limitNum: Number)</p>
<div class="hlcode"><pre><span class="err">找到最近别人分享给你的日程</span>
</pre></div>


<p>findNearlyDate(type: String, limitNum: Number)</p>
<div class="hlcode"><pre><span class="err">参数</span><span class="o">:</span> <span class="err">第一个参数是判断是哪种行为</span><span class="p">,</span><span class="err">然后调用上面</span><span class="mi">4</span><span class="err">种方法的其中一种</span>
<span class="err">注意</span><span class="p">,</span><span class="err">其他类似这种逻辑的函数请也这样设计</span><span class="p">,</span><span class="err">尽量少使用</span><span class="k">if</span><span class="p">...</span><span class="k">else</span> <span class="k">if</span><span class="p">...</span> <span class="k">else</span><span class="err">语法</span>
</pre></div>


<h4 id="_6">修改方法</h4>
<blockquote>
<p>参数带问好说明可选,所有cb代表回调函数</p>
</blockquote>
<p>addDate(json: Object, cb?: Function)</p>
<div class="hlcode"><pre><span class="err">参数</span><span class="o">:</span> <span class="n">json</span> <span class="o">=</span><span class="p">{</span>
    <span class="nl">create_id:</span> <span class="n">String</span>
    <span class="nl">include:</span> <span class="n">Match</span><span class="p">.</span><span class="n">Optional</span> <span class="n">Array</span>
    <span class="nl">start_time:</span> <span class="n">Number</span>
    <span class="nl">end_time:</span> <span class="n">Number</span>
    <span class="nl">content:</span> <span class="n">String</span>
    <span class="nl">title:</span> <span class="n">String</span>
    <span class="nl">groups:</span> <span class="n">Array</span>
<span class="p">}</span>
<span class="err">功能</span><span class="o">:</span> <span class="err">添加一个日程</span>
</pre></div>


<p>updatePersonDate(json: Object, cb?: Function)</p>
<div class="hlcode"><pre><span class="err">参数同上</span>
<span class="err">功能</span><span class="o">:</span> <span class="err">修改一个日程</span>
</pre></div>


<p>delDate(json: Object, cb?: Function)</p>
<div class="hlcode"><pre><span class="err">为修改日程服务</span><span class="p">,</span><span class="err">逻辑如下：如果是创建者删除该日程，即更改日程的</span><span class="n">status</span><span class="p">,</span><span class="err">大家都看不见</span>

<span class="err">如果不是创建删除，即更改</span><span class="n">include</span><span class="err">内相应地数据，即不关注</span>
</pre></div>


<h4 id="_7">表权限</h4>
<p>insert: 创建人id和当前用户相同的情况下可以创建</p>
<p>update:</p>
<blockquote>
<ol>
<li>
<p>自己能改自己的</p>
</li>
<li>
<p>我能改别人没锁的</p>
</li>
</ol>
</blockquote>
<h3 id="db-friendcoffee">DB-friend.coffee</h3>
<p>创建<code>DB.Friend</code>实例,并扩展方法</p>
<h4 id="_8">表权限</h4>
<p>insert: _id和操作人id相同</p>
<p>update: _id和操作人id相同</p>
<h4 id="_9">添加好友的方法</h4>
<p>friendMyInfo</p>
<div class="hlcode"><pre><span class="err">取出自己的好友信息</span>
</pre></div>


<p>initFriend(id: String, cb: Function, isAgree: Boolean)</p>
<div class="hlcode"><pre><span class="err">参数</span><span class="o">:</span> <span class="n">id</span><span class="err">需要添加好友的</span><span class="n">id</span><span class="p">,</span> <span class="n">cb</span><span class="o">:</span><span class="err">毁掉函数</span><span class="p">,</span> <span class="n">isAgree</span><span class="o">:</span> <span class="err">是否初始化的时候就同意加为好友</span>
<span class="err">功能</span><span class="o">:</span> <span class="err">当自己没有</span><span class="n">friend</span><span class="err">文档的时候</span><span class="p">,</span><span class="err">建立一个自己的</span><span class="n">friend</span><span class="err">文档</span><span class="p">,</span><span class="err">修改完后重新订阅</span><span class="n">friendInfo</span><span class="p">,</span><span class="err">因为用户表不是活性数据</span>
</pre></div>


<p>updateFriends(friends, cb)</p>
<div class="hlcode"><pre><span class="err">修改自己的</span><span class="n">friend</span><span class="err">表列</span><span class="p">,</span><span class="err">修改完后重新订阅</span><span class="n">friendInfo</span>
</pre></div>


<p>sendQueryAddPerson(id, cb)</p>
<div class="hlcode"><pre><span class="err">发送好友请求</span><span class="p">,</span><span class="err">存在多种情况</span><span class="p">,</span><span class="err">逻辑相当复杂</span><span class="p">..</span>
<span class="err">一般只需要使用即可</span>
</pre></div>


<p>allowQueryAddPerson(id, cb)</p>
<div class="hlcode"><pre><span class="err">同意好友邀请</span>
<span class="err">操作逻辑</span>
<span class="mi">1</span><span class="err">，将申请人中对应的</span><span class="n">status</span><span class="err">改为</span><span class="mi">1</span><span class="err">，当对方已经是</span><span class="mi">1</span><span class="err">的时候报错，如果不是，改为</span><span class="mi">1</span>
<span class="mi">2</span><span class="err">，将自己的</span><span class="n">friend</span><span class="err">表列中加上申请人，如果已经存在就更改</span><span class="n">status</span><span class="err">的值，逻辑同上</span> 
</pre></div>


<p>denyQueryAddPerson(id, cb)</p>
<div class="hlcode"><pre><span class="err">逻辑和上面两个方法基本一致</span>
</pre></div>


<h3 id="db-groupcoffee">DB-group.coffee</h3>
<p>创建实例<code>DB.Groups</code>(没用group是因为group在MongoDB里面是关键字)</p>
<h4 id="_10">表权限</h4>
<p>insert: 创建人id和操作人相同</p>
<p>update: 同上</p>
<p>remove: 同上</p>
<h4 id="_11">查询方法</h4>
<p>findInGroup(id)</p>
<div class="hlcode"><pre><span class="err">查找某个人和你有交集的群组</span>
</pre></div>


<p>getMemberListById(id)</p>
<div class="hlcode"><pre><span class="err">根据</span><span class="n">Id</span><span class="err">返回</span><span class="n">memberList</span>
</pre></div>


<h4 id="_12">操作方法</h4>
<p>addGroup(name: String, member_list: Array, cb: Function)</p>
<div class="hlcode"><pre><span class="err">新建一个群组</span>
</pre></div>


<p>updateMemberList(id: String, json: Object, cb: Function)</p>
<div class="hlcode"><pre><span class="err">修改一个群组里面的</span><span class="n">member_list</span><span class="err">字段</span>
</pre></div>


<p>removeGroup(id: String, cb: Function)</p>
<div class="hlcode"><pre><span class="err">删除群组</span>
</pre></div>


<h3 id="db-initcoffee">DB-init.coffee</h3>
<p>在后台实例化了<code>DB.LoginInfo</code>和<code>DB.VCode</code>  </p>
<p>DB.VCode.getCode(phone: String)</p>
<div class="hlcode"><pre><span class="err">获取该手机号的验证码</span>
</pre></div>


<h3 id="db-notificationcoffee">DB-notification.coffee</h3>
<blockquote>
<p>实例化了<code>notification</code>表</p>
</blockquote>
<h4 id="_13">表权限</h4>
<p>insert: 操作人id或目标人id为自己</p>
<p>update: 同上</p>
<h4 id="notification">notification的设计标准</h4>
<blockquote>
<p>DB.Notification.msg命名空间存放的是每种类型消息的描述文字</p>
<p>DB.Notification.eventType命名空间存放的是每种消息的处理办法,无需理解,会调用即可,请保持这样的设计模式不变</p>
</blockquote>
<h4 id="notification_1">notification的相关方法</h4>
<p>insertNotification(id: String, fnName: String, data?: anyType, cb: Funtion)</p>
<div class="hlcode"><pre><span class="err">参数</span><span class="o">:</span><span class="n">fnName</span><span class="err">指的是生成这条消息的时候的函数名</span><span class="p">,</span><span class="err">也就是</span><span class="n">eventType</span><span class="p">,</span><span class="n">data</span><span class="err">是可选值</span><span class="p">,</span><span class="err">存放处理这条消息的时候需要用到的数据</span>
<span class="err">功能</span><span class="o">:</span> <span class="err">生成一条消息</span> 
</pre></div>


<h3 id="db-usercoffee">DB-user.coffee</h3>
<blockquote>
<p>对<code>Meteor.users</code>做扩展</p>
</blockquote>
<h4 id="_14">表权限</h4>
<p>update: 仅允许修改emails和profile字段</p>
<h4 id="_15">辅助函数</h4>
<p>getUserNameById(id)</p>
<div class="hlcode"><pre><span class="err">根据</span><span class="n">id</span><span class="err">返回名字</span>
</pre></div>


<p>getShareCal()</p>
<div class="hlcode"><pre><span class="err">获取分享给我日历的人的</span><span class="n">id</span>
</pre></div>


<h4 id="_16">人员操作</h4>
<p>invitePerson(keyword: String, cb: Function)</p>
<div class="hlcode"><pre><span class="err">参数</span><span class="o">:</span> <span class="n">keyword</span><span class="err">用于查找人员</span><span class="p">,</span><span class="n">phone</span><span class="err">或者</span><span class="n">email</span>
</pre></div>


<h4 id="_17">共享操作</h4>
<p>shareCalToMem(id: String, type: String, cb: Function)</p>
<div class="hlcode"><pre><span class="err">调用</span><span class="n">shareMyCal</span><span class="err">方法和</span><span class="n">cancelShareMyCal</span><span class="err">来完成相应功能，相当于入口函数</span>
</pre></div>


<p>shareMyCal(id: String, cb: Function)</p>
<div class="hlcode"><pre><span class="err">共享自己的日历给某人</span>
</pre></div>


<p>cancelShareMyCal(id: String, cb: Function)</p>
<div class="hlcode"><pre><span class="err">取消日历的共享</span>
</pre></div>


<h2 id="router">router(路由)</h2>
<h3 id="initroutercoffee">initRouter.coffee</h3>
<p>这个文件主要是路由的一些设置</p>
<div class="hlcode"><pre><span class="nx">Router</span><span class="p">.</span><span class="nx">onBeforeAction</span><span class="p">(</span> <span class="o">-&gt;</span>
    <span class="k">if</span> <span class="o">!</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">userId</span><span class="p">()</span>
        <span class="nx">Router</span><span class="p">.</span><span class="nx">go</span> <span class="s1">&#39;signin&#39;</span>
    <span class="k">else</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span>
<span class="p">,</span> <span class="p">{</span>
    <span class="nx">except</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;join&#39;</span><span class="p">,</span> <span class="s1">&#39;signin&#39;</span><span class="p">]</span>
<span class="p">})</span>
</pre></div>


<p>这是判断除了登陆和注册以外的所有界面,如果没登陆,就跳登陆</p>
<div class="hlcode"><pre><span class="nx">Router</span><span class="p">.</span><span class="nx">onBeforeAction</span> <span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">userId</span><span class="p">()</span><span class="o">?</span>
        <span class="nx">Router</span><span class="p">.</span><span class="nx">go</span> <span class="s1">&#39;home&#39;</span>
    <span class="k">else</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span>
<span class="p">,</span> <span class="p">{</span>
    <span class="nx">only</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;join&#39;</span><span class="p">,</span> <span class="s1">&#39;signin&#39;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>


<p>这是判断登陆和注册界面,如果已经登陆了,就不允许进入这两个界面</p>
<div class="hlcode"><pre><span class="err">#</span> <span class="err">等订阅完</span>
<span class="nx">Router</span><span class="p">.</span><span class="nx">onBeforeAction</span> <span class="o">-&gt;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span> <span class="k">if</span> <span class="k">this</span><span class="p">.</span><span class="nx">ready</span><span class="p">()</span> 

<span class="err">#</span> <span class="err">全局订阅用户信息</span>
<span class="nx">Router</span><span class="p">.</span><span class="nx">waitOn</span> <span class="o">-&gt;</span>
    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span> <span class="s1">&#39;userData&#39;</span>
    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span> <span class="s1">&#39;calendar&#39;</span>
    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span> <span class="s1">&#39;friend&#39;</span>
    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span> <span class="s1">&#39;friendInfo&#39;</span>
    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span> <span class="s1">&#39;notification&#39;</span>
    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span> <span class="s1">&#39;group&#39;</span>
<span class="p">,</span> <span class="p">{</span>
    <span class="nx">except</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;join&#39;</span><span class="p">,</span> <span class="s1">&#39;signin&#39;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>


<p>这一段是订阅相关的</p>
<h3 id="routercoffee">router.coffee</h3>
<p>这是主要的路由文件</p>
<div class="hlcode"><pre><span class="n">Router</span><span class="p">.</span><span class="n">configure</span> 
    <span class="n">layoutTemplate</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">appBody</span><span class="err">&#39;</span>
    <span class="nl">notFoundTemplate:</span> <span class="err">&#39;</span><span class="n">appNotFound</span><span class="err">&#39;</span>
    <span class="nl">loadingTemplate:</span> <span class="err">&#39;</span><span class="n">appLoading</span><span class="err">&#39;</span>
</pre></div>


<p>设置布局模板,404模板,loading模板</p>
<div class="hlcode"><pre><span class="cp"># 记录当前时间的session变量名</span>
<span class="n">CULOOK</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">cuLook</span><span class="err">&#39;</span>
<span class="n">DEFAULT_VIEW</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">today</span><span class="err">&#39;</span>
<span class="n">VIEW_TYPE</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">viewType</span><span class="err">&#39;</span>
<span class="n">ERRORS_KEY</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">joinErrors</span><span class="err">&#39;</span>

<span class="cp"># 当前查看的人员</span>
<span class="n">CU_MEMBER</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">cuMember</span><span class="err">&#39;</span>
</pre></div>


<p>把Session的名字都提前声明,这样如果做出修改的时候,直接改这个变量就行了</p>
<div class="hlcode"><pre><span class="n">Router</span><span class="p">.</span><span class="n">map</span> <span class="o">-&gt;</span>
</pre></div>


<p>这里开始定义路由规则</p>
<div class="hlcode"><pre><span class="cp"># 主页</span>
<span class="n">this</span><span class="p">.</span><span class="n">route</span> <span class="err">&#39;</span><span class="n">home</span><span class="err">&#39;</span><span class="p">,</span> 
    <span class="n">path</span><span class="o">:</span> <span class="sc">&#39;/&#39;</span><span class="p">,</span>
    <span class="nl">action:</span> <span class="o">-&gt;</span>
        <span class="n">Router</span><span class="p">.</span><span class="n">go</span><span class="p">(</span><span class="err">&#39;</span><span class="n">calendar</span><span class="err">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">ready</span><span class="p">()</span>


<span class="cp">#  注册</span>
<span class="n">this</span><span class="p">.</span><span class="n">route</span> <span class="err">&#39;</span><span class="n">join</span><span class="err">&#39;</span><span class="p">,</span> 
    <span class="n">path</span><span class="o">:</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">join</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="nl">layoutTemplate:</span> <span class="err">&#39;&#39;</span><span class="p">,</span>
    <span class="nl">action:</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="n">Template</span><span class="p">.</span><span class="n">join</span><span class="p">.</span><span class="n">timer</span>
            <span class="n">Meteor</span><span class="p">.</span><span class="n">clearInterval</span> <span class="n">Template</span><span class="p">.</span><span class="n">join</span><span class="p">.</span><span class="n">timer</span>
        <span class="n">this</span><span class="p">.</span><span class="n">render</span><span class="p">()</span>

<span class="cp"># 登陆</span>
<span class="n">this</span><span class="p">.</span><span class="n">route</span> <span class="err">&#39;</span><span class="n">signin</span><span class="err">&#39;</span><span class="p">,</span> 
    <span class="n">path</span><span class="o">:</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">signin</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="nl">layoutTemplate:</span> <span class="err">&#39;&#39;</span><span class="p">,</span>
    <span class="nl">action:</span> <span class="o">-&gt;</span>
        <span class="n">this</span><span class="p">.</span><span class="n">render</span><span class="p">()</span>
</pre></div>


<p>这里是主页,注册,登陆的路由设置,其中注册的clearInterval是除去发验证码的定时器用的</p>
<div class="hlcode"><pre><span class="cp">#  日历页面</span>
<span class="n">this</span><span class="p">.</span><span class="n">route</span> <span class="err">&#39;</span><span class="n">calendar</span><span class="err">&#39;</span><span class="p">,</span> 
    <span class="n">action</span><span class="o">:</span> <span class="o">-&gt;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">Date</span><span class="p">.</span><span class="n">now</span><span class="p">()</span>
        <span class="err">#</span> <span class="err">获取当前查看的视图模式</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">query</span><span class="p">.</span><span class="n">view</span> <span class="n">or</span> <span class="n">DEFAULT_VIEW</span>
        <span class="n">Common</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">goToday</span><span class="p">()</span> <span class="k">if</span> <span class="n">view</span> <span class="n">is</span> <span class="err">&#39;</span><span class="n">today</span><span class="err">&#39;</span>
        <span class="err">#</span> <span class="err">设置默认</span><span class="n">Session</span>
        <span class="n">Session</span><span class="p">.</span><span class="n">setDefault</span> <span class="n">CULOOK</span><span class="p">,</span> <span class="n">now</span>
        <span class="n">Session</span><span class="p">.</span><span class="n">set</span> <span class="n">CU_MEMBER</span><span class="p">,</span> <span class="n">null</span>
        <span class="err">#</span> <span class="err">设置视图模式</span>
        <span class="n">Session</span><span class="p">.</span><span class="n">set</span> <span class="n">VIEW_TYPE</span><span class="p">,</span> <span class="n">view</span>
        <span class="n">this</span><span class="p">.</span><span class="n">render</span><span class="p">()</span>
</pre></div>


<p>日历的路由逻辑,从路由地址中读取当前的视图类型,然后操作Session</p>
<div class="hlcode"><pre><span class="cp"># 群组页面</span>
<span class="n">this</span><span class="p">.</span><span class="n">route</span> <span class="err">&#39;</span><span class="n">group</span><span class="err">&#39;</span><span class="p">,</span> 
    <span class="n">path</span><span class="o">:</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">group</span><span class="o">/:</span><span class="n">_id</span><span class="o">?</span><span class="err">&#39;</span>
    <span class="nl">action:</span> <span class="o">-&gt;</span>
        <span class="n">Session</span><span class="p">.</span><span class="n">set</span> <span class="n">CU_MEMBER</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">_id</span>
        <span class="n">this</span><span class="p">.</span><span class="n">render</span><span class="p">()</span>


<span class="cp"># 共享页面</span>
<span class="n">this</span><span class="p">.</span><span class="n">route</span> <span class="err">&#39;</span><span class="n">share</span><span class="err">&#39;</span><span class="p">,</span> 
    <span class="n">path</span><span class="o">:</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">share</span><span class="o">/:</span><span class="n">_id</span><span class="o">?</span><span class="err">&#39;</span>
    <span class="nl">action:</span> <span class="o">-&gt;</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">query</span><span class="p">.</span><span class="n">view</span> <span class="n">or</span> <span class="err">&#39;</span><span class="n">month</span><span class="err">&#39;</span>
        <span class="n">Session</span><span class="p">.</span><span class="n">set</span> <span class="n">VIEW_TYPE</span><span class="p">,</span> <span class="n">view</span>
        <span class="n">Session</span><span class="p">.</span><span class="n">set</span> <span class="n">CU_MEMBER</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">_id</span>
        <span class="n">this</span><span class="p">.</span><span class="n">render</span><span class="p">()</span>
</pre></div>


<p>群组和共享的页面,也是通过路由地址来控制Session</p>
<h2 id="basecoffee">base.coffee(初始化的命名空间定义)</h2>
<p>用来初始化命名空间,做了momentJs的国际化处理</p>
<h1 id="public">public(静态资源)</h1>
<h2 id="fonts">fonts(字体文件)</h2>
<h2 id="img">img(图片资源)</h2>
<h1 id="server">server(后台代码)</h1>
<h3 id="accounts-helpercoffee">accounts-helper.coffee(登陆的辅助方法)</h3>
<p>登陆需要用到的辅助方法</p>
<div class="hlcode"><pre><span class="cp"># 注册时加上md5、注册时间</span>
<span class="n">Accounts</span><span class="p">.</span><span class="n">onCreateUser</span> <span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">profile</span>
    <span class="k">if</span> <span class="n">profile</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">profile</span><span class="p">.</span><span class="n">passwordCache</span>
        <span class="n">encryption</span> <span class="o">=</span> <span class="n">crypto</span><span class="p">.</span><span class="n">createHash</span> <span class="err">&#39;</span><span class="n">md5</span><span class="err">&#39;</span>
                        <span class="p">.</span><span class="n">update</span> <span class="n">password</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">utf8</span><span class="err">&#39;</span>
                        <span class="p">.</span><span class="n">digest</span> <span class="err">&#39;</span><span class="n">hex</span><span class="err">&#39;</span>
        <span class="n">regtime</span> <span class="o">=</span> <span class="n">Date</span><span class="p">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">profile</span><span class="p">.</span><span class="n">encryption</span> <span class="o">=</span> <span class="n">encryption</span> <span class="k">if</span> <span class="n">encryption</span>
        <span class="n">profile</span><span class="p">.</span><span class="n">regtime</span> <span class="o">=</span> <span class="n">regtime</span>
        <span class="n">delete</span> <span class="n">profile</span><span class="p">.</span><span class="n">passwordCache</span>
        <span class="n">user</span><span class="p">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span>
    <span class="k">return</span> <span class="n">user</span><span class="p">;</span>

<span class="cp"># 登陆的时候更新登陆日志</span>
<span class="n">Accounts</span><span class="p">.</span><span class="n">onLogin</span> <span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">userId</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">_id</span>
    <span class="n">oDate</span> <span class="o">=</span> <span class="n">moment</span><span class="p">()</span>
    <span class="n">loginInfo</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">loginInfo</span><span class="p">.</span><span class="n">member_id</span>
    <span class="n">loginInfo</span><span class="p">.</span><span class="n">logindata</span> <span class="o">=</span> <span class="n">oDate</span><span class="p">.</span><span class="n">format</span> <span class="err">&#39;</span><span class="n">YYYY</span><span class="o">-</span><span class="n">MM</span><span class="o">-</span><span class="n">DD</span><span class="err">&#39;</span>
    <span class="n">loginInfo</span><span class="p">.</span><span class="n">logintime</span> <span class="o">=</span> <span class="n">oDate</span><span class="p">.</span><span class="n">format</span> <span class="err">&#39;</span><span class="n">YYYY</span><span class="o">-</span><span class="n">MM</span><span class="o">-</span><span class="n">DD</span> <span class="n">HH</span><span class="o">:</span><span class="n">MM</span><span class="o">:</span><span class="n">SS</span><span class="err">&#39;</span>
    <span class="n">loginInfo</span><span class="p">.</span><span class="n">loginTimeInt</span> <span class="o">=</span> <span class="n">oDate</span><span class="p">.</span><span class="n">format</span> <span class="sc">&#39;x&#39;</span>
    <span class="n">loginInfo</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="sc">&#39;w&#39;</span>
    <span class="n">DB</span><span class="p">.</span><span class="n">LoginInfo</span><span class="p">.</span><span class="n">add</span> <span class="n">loginInfo</span>
</pre></div>


<p>这两个方法是用于处理注册和登陆的,前者是在注册的时候添加md5加密的密码,还有一些相关信息,后者是登陆的时候在login表里面记录登陆的信息</p>
<div class="hlcode"><pre><span class="cp"># 短信格式和内容</span>
<span class="n">getMsgContent</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">getMsgContent</span><span class="p">.</span><span class="n">setCode</span> <span class="o">=</span> <span class="p">(</span><span class="n">phone</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">return</span> <span class="s">&quot;#{}&quot;</span>
</pre></div>


<p>设置短信的内容,未完成,加上短信接口的时候只需要补全这个函数,然后去调用即可</p>
<div class="hlcode"><pre><span class="cp"># 设置验证码</span>
<span class="n">Meteor</span><span class="p">.</span><span class="n">methods</span> <span class="p">{</span>
    <span class="nl">setCode:</span> <span class="p">(</span><span class="n">phone</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">old</span> <span class="o">=</span> <span class="n">DB</span><span class="p">.</span><span class="n">VCode</span><span class="p">.</span><span class="n">getCode</span> <span class="n">phone</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">_</span><span class="p">.</span><span class="n">random</span> <span class="mi">100000</span><span class="p">,</span> <span class="mi">999999</span>
        <span class="err">#</span> <span class="err">先判断这个手机号是否已经注册了</span>
        <span class="n">man</span> <span class="o">=</span> <span class="n">Meteor</span><span class="p">.</span><span class="n">users</span><span class="p">.</span><span class="n">findOne</span> <span class="p">{</span>
            <span class="nl">username:</span> <span class="n">phone</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">man</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="nl">code:</span> <span class="mi">0</span>
                <span class="nl">result:</span> <span class="err">&#39;改手机号已注册&#39;</span>
            <span class="p">}</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">Date</span><span class="p">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">console</span><span class="p">.</span><span class="n">log</span> <span class="s">&quot;#{phone}的验证码为#{code}&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">getMsgContent</span><span class="p">.</span><span class="n">setCode</span> <span class="n">phone</span>
        <span class="k">if</span> <span class="n">old</span><span class="p">.</span><span class="n">code</span>
            <span class="n">VCodeId</span> <span class="o">=</span> <span class="n">old</span><span class="p">.</span><span class="n">result</span><span class="p">.</span><span class="n">_id</span>
            <span class="n">isSuccess</span> <span class="o">=</span> <span class="n">DB</span><span class="p">.</span><span class="n">VCode</span><span class="p">.</span><span class="n">update</span> <span class="p">{</span>
                <span class="nl">_id:</span> <span class="n">VCodeId</span>
            <span class="p">},</span> <span class="p">{</span>
                <span class="err">$</span><span class="n">set</span><span class="o">:</span> 
                    <span class="n">code</span><span class="o">:</span> <span class="n">code</span>
                    <span class="nl">create_time:</span> <span class="n">now</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">isSuccess</span>
                <span class="err">#</span> <span class="err">发短信给用户</span>
                <span class="n">Meteor</span><span class="p">.</span><span class="n">call</span> <span class="err">&#39;</span><span class="n">sendMsg</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">phone</span><span class="p">,</span> <span class="n">msg</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="nl">code:</span> <span class="mi">1</span>
                    <span class="nl">result:</span> 
                        <span class="n">code</span><span class="o">:</span> <span class="n">code</span>
                        <span class="nl">createTime:</span> <span class="n">now</span>
                <span class="p">}</span>
            <span class="k">else</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="nl">code:</span> <span class="mi">0</span>
                    <span class="nl">result:</span> <span class="err">&#39;获取验证码错误，请稍后重试&#39;</span>
                <span class="p">}</span>
        <span class="k">else</span> 
            <span class="n">isSuccess</span> <span class="o">=</span> <span class="n">DB</span><span class="p">.</span><span class="n">VCode</span><span class="p">.</span><span class="n">insert</span> <span class="p">{</span>
                <span class="nl">phone:</span> <span class="n">phone</span>
                <span class="nl">code:</span> <span class="n">code</span>
                <span class="nl">create_time:</span> <span class="n">now</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">isSuccess</span>
                <span class="err">#</span> <span class="err">发短信给用户</span>
                <span class="n">Meteor</span><span class="p">.</span><span class="n">call</span> <span class="err">&#39;</span><span class="n">sendMsg</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">phone</span><span class="p">,</span> <span class="n">msg</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="nl">code:</span> <span class="mi">1</span>
                    <span class="nl">result:</span> 
                        <span class="n">code</span><span class="o">:</span> <span class="n">code</span>
                        <span class="nl">createTime:</span> <span class="n">now</span>
                <span class="p">}</span>
            <span class="k">else</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="nl">code:</span> <span class="mi">0</span>
                    <span class="nl">result:</span> <span class="err">&#39;获取验证码错误，请稍后重试&#39;</span>
                <span class="p">}</span>

    <span class="err">#</span> <span class="err">发送短信的方法</span>
    <span class="err">#</span> <span class="err">未完成</span>
    <span class="err">#</span> <span class="err">未完成</span>
    <span class="err">#</span> <span class="err">未完成</span>
    <span class="nl">sendMsg:</span> <span class="p">(</span><span class="n">phone</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">check</span> <span class="n">phone</span><span class="p">,</span> <span class="n">String</span>
        <span class="n">check</span> <span class="n">msg</span><span class="p">,</span> <span class="n">String</span>
    <span class="err">#</span> <span class="err">未完成</span>
    <span class="err">#</span> <span class="err">未完成</span>
    <span class="err">#</span> <span class="err">未完成</span>
    <span class="err">#</span> <span class="err">未完成</span>
    <span class="err">#</span> <span class="err">未完成</span>
<span class="p">}</span>
</pre></div>


<p>这是发送验证码的两个方法,第一个是生成验证码,第二个是发送验证码,未完成</p>
<h3 id="membercoffee">member.coffee(成员的后台方法)</h3>
<p>人员相关的后台方法,因为有些数据没推送到前台,所以通过后台计算后返回前台</p>
<div class="hlcode"><pre><span class="nl">findPerson:</span> <span class="p">(</span><span class="n">keyword</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">check</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">String</span>
    <span class="err">#</span> <span class="err">搜索手机号就过滤掉</span><span class="n">email</span>
    <span class="n">man</span> <span class="o">=</span> <span class="n">Meteor</span><span class="p">.</span><span class="n">users</span><span class="p">.</span><span class="n">findOne</span> <span class="p">{</span>
        <span class="nl">username:</span> <span class="n">keyword</span>
    <span class="p">},</span> <span class="p">{</span>
        <span class="nl">fields:</span>
            <span class="nl">services:</span> <span class="nb">false</span>
            <span class="nl">emails:</span> <span class="nb">false</span>
    <span class="p">}</span>
    <span class="n">unless</span> <span class="n">man</span>
        <span class="err">#</span> <span class="err">过滤掉手机号</span>
        <span class="n">man</span> <span class="o">=</span> <span class="n">Meteor</span><span class="p">.</span><span class="n">users</span><span class="p">.</span><span class="n">findOne</span> <span class="p">{</span>
            <span class="err">&#39;</span><span class="n">emails</span><span class="mf">.0</span><span class="p">.</span><span class="n">address</span><span class="err">&#39;</span><span class="o">:</span> <span class="n">keyword</span>
        <span class="p">},</span> <span class="p">{</span>
            <span class="nl">fields:</span>
                <span class="nl">services:</span> <span class="nb">false</span>
                <span class="nl">username:</span> <span class="nb">false</span>
        <span class="p">}</span>
    <span class="k">if</span> <span class="n">man</span>  
        <span class="k">return</span> <span class="p">{</span>
            <span class="nl">result:</span> <span class="n">man</span>
        <span class="p">}</span>
    <span class="k">else</span> 
        <span class="k">return</span> <span class="p">{</span>
            <span class="nl">error:</span> <span class="err">&#39;无搜索结果&#39;</span>
        <span class="p">}</span>
</pre></div>


<p>用于添加联系人的时候,搜索人员使用,输入邮箱或手机查找相关人员,精确搜索</p>
<div class="hlcode"><pre><span class="cp"># 返回固定人员的名字</span>
<span class="nl">getPersonName:</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">check</span> <span class="n">id</span><span class="p">,</span> <span class="n">String</span>
    <span class="n">somebody</span> <span class="o">=</span> <span class="n">Meteor</span><span class="p">.</span><span class="n">users</span><span class="p">.</span><span class="n">findOne</span> <span class="n">id</span>
    <span class="k">if</span> <span class="n">somebody</span>
        <span class="k">return</span> <span class="n">somebody</span><span class="p">.</span><span class="n">profile</span><span class="p">.</span><span class="n">name</span>
    <span class="k">else</span>
        <span class="k">return</span> <span class="err">&#39;未知用户&#39;</span>
</pre></div>


<p>根据id返回对应人员的名字使用</p>
<div class="hlcode"><pre><span class="cp"># 同意好友请求之后修改申请人的status状态</span>
<span class="cp"># id是申请人的id</span>
<span class="nl">agreeFriendQuery:</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">check</span> <span class="n">id</span><span class="p">,</span> <span class="n">String</span>
    <span class="n">check</span> <span class="n">status</span><span class="p">,</span> <span class="n">Number</span>
    <span class="n">myId</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">userId</span>
    <span class="n">console</span><span class="p">.</span><span class="n">log</span> <span class="n">myId</span><span class="p">,</span> <span class="n">status</span>
    <span class="k">return</span> <span class="n">DB</span><span class="p">.</span><span class="n">Friend</span><span class="p">.</span><span class="n">update</span> <span class="p">{</span>
        <span class="nl">_id:</span> <span class="n">id</span>
        <span class="err">&#39;</span><span class="n">friends</span><span class="p">.</span><span class="n">_id</span><span class="err">&#39;</span><span class="o">:</span> <span class="n">myId</span>
    <span class="p">},</span> <span class="p">{</span>
        <span class="err">$</span><span class="n">set</span><span class="o">:</span> 
            <span class="err">&#39;</span><span class="n">friends</span><span class="p">.</span><span class="err">$</span><span class="p">.</span><span class="n">status</span><span class="err">&#39;</span><span class="o">:</span> <span class="n">status</span>
    <span class="p">}</span>
</pre></div>


<p>这个是同意别人的好友请求的时候调用的方法,因为同意的那一瞬间,还不是好友,所以联系人的资料没有提送过来,需要通过后台修改</p>
<h3 id="publishcoffee">publish.coffee(发布逻辑)</h3>
<p>发布数据的逻辑</p>
<div class="hlcode"><pre><span class="n">Meteor</span><span class="p">.</span><span class="n">publish</span> <span class="err">&#39;</span><span class="n">userData</span><span class="err">&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="n">userId</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">userId</span>
    <span class="k">if</span> <span class="n">userId</span><span class="o">?</span>
        <span class="k">return</span> <span class="n">Meteor</span><span class="p">.</span><span class="n">users</span><span class="p">.</span><span class="n">find</span> <span class="p">{</span>
            <span class="nl">_id:</span> <span class="n">userId</span>
        <span class="p">},</span> <span class="p">{</span>
            <span class="nl">fields:</span> <span class="p">{</span>
                <span class="nl">services:</span> <span class="nb">false</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="k">else</span>
        <span class="n">this</span><span class="p">.</span><span class="n">ready</span><span class="p">()</span>
        <span class="k">return</span>
</pre></div>


<p>发布用户数据的逻辑,除了services字段,其余抛出去,这里只订阅自己的数据</p>
<div class="hlcode"><pre><span class="n">Meteor</span><span class="p">.</span><span class="n">publish</span> <span class="err">&#39;</span><span class="n">calendar</span><span class="err">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">idArr</span><span class="p">,</span> <span class="n">filter</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">userId</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">userId</span>
    <span class="n">idArr</span> <span class="o">=</span> <span class="n">idArr</span> <span class="n">or</span> <span class="p">[</span><span class="n">userId</span><span class="p">]</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">{</span>
        <span class="err">$</span><span class="n">or</span><span class="o">:</span> <span class="p">[{</span>
            <span class="nl">create_id:</span> 
                <span class="err">$</span><span class="n">in</span><span class="o">:</span> <span class="n">idArr</span>
        <span class="p">},</span> <span class="p">{</span>
            <span class="nl">include:</span>
                <span class="err">$</span><span class="n">elemMatch</span><span class="o">:</span> 
                    <span class="n">_id</span><span class="o">:</span> 
                        <span class="err">$</span><span class="n">in</span><span class="o">:</span> <span class="n">idArr</span>
                    <span class="nl">status:</span> <span class="mi">0</span>
        <span class="p">}]</span>
    <span class="p">}</span>
    <span class="n">filter</span> <span class="o">=</span> <span class="n">filter</span> <span class="n">or</span> <span class="p">{}</span>
    <span class="k">return</span> <span class="n">DB</span><span class="p">.</span><span class="n">Calendar</span><span class="p">.</span><span class="n">find</span> <span class="n">query</span><span class="p">,</span> <span class="n">filter</span>
</pre></div>


<p>日历的发布逻辑,发布所有自己创建的和自己参与的日历</p>
<div class="hlcode"><pre><span class="cp"># 发布我的联系人</span>
<span class="n">Meteor</span><span class="p">.</span><span class="n">publish</span> <span class="err">&#39;</span><span class="n">friendInfo</span><span class="err">&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="n">userId</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">userId</span>
    <span class="err">#</span> <span class="err">找到我自己</span>
    <span class="n">me</span> <span class="o">=</span> <span class="n">DB</span><span class="p">.</span><span class="n">Friend</span><span class="p">.</span><span class="n">findOne</span> <span class="p">{</span>
        <span class="nl">_id:</span> <span class="n">userId</span>
    <span class="p">}</span>
    <span class="err">#</span> <span class="err">取到</span><span class="n">friends</span>
    <span class="n">friends</span> <span class="o">=</span> <span class="n">me</span> <span class="n">and</span> <span class="n">me</span><span class="p">.</span><span class="n">friends</span> <span class="n">or</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">friends</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">friendId</span> <span class="o">=</span> <span class="n">_</span><span class="p">.</span><span class="n">pluck</span> <span class="n">friends</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">_id</span><span class="err">&#39;</span>
        <span class="k">return</span> <span class="n">Meteor</span><span class="p">.</span><span class="n">users</span><span class="p">.</span><span class="n">find</span> <span class="p">{</span>
            <span class="nl">_id:</span>
                <span class="err">$</span><span class="n">in</span><span class="o">:</span> <span class="n">friendId</span>
        <span class="p">},</span> <span class="p">{</span>
            <span class="nl">fields:</span>
                <span class="nl">services:</span> <span class="nb">false</span>
        <span class="p">}</span>
    <span class="k">else</span>
        <span class="n">this</span><span class="p">.</span><span class="n">ready</span><span class="p">()</span>
</pre></div>


<p>根据我的friend数据,去users表里订阅相关数据,<strong>不同于订阅friend</strong>,这个是订阅联系人在users表里的数据,不是订阅自己在DB.Friend里的数据</p>
<div class="hlcode"><pre><span class="n">Meteor</span><span class="p">.</span><span class="n">publish</span> <span class="err">&#39;</span><span class="n">friend</span><span class="err">&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="n">userId</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">userId</span>
    <span class="k">return</span> <span class="n">DB</span><span class="p">.</span><span class="n">Friend</span><span class="p">.</span><span class="n">find</span> <span class="p">{</span>
        <span class="nl">_id:</span> <span class="n">userId</span>
    <span class="p">}</span>
</pre></div>


<p>订阅我在friend表里面的数据</p>
<div class="hlcode"><pre><span class="n">Meteor</span><span class="p">.</span><span class="n">publish</span> <span class="err">&#39;</span><span class="n">notification</span><span class="err">&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="n">userId</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">userId</span>
    <span class="k">return</span> <span class="n">DB</span><span class="p">.</span><span class="n">Notification</span><span class="p">.</span><span class="n">find</span> <span class="p">{</span>
        <span class="err">$</span><span class="n">or</span><span class="o">:</span> <span class="p">[{</span>
            <span class="nl">target_id:</span> <span class="n">userId</span>
        <span class="p">},</span> <span class="p">{</span>
            <span class="nl">bulletin:</span> <span class="nb">true</span> 
        <span class="p">}]</span>
    <span class="p">}</span>
</pre></div>


<p>发布通知,发布目标者是自己的通知,或者公告(bulletin: true)</p>
<div class="hlcode"><pre><span class="n">Meteor</span><span class="p">.</span><span class="n">publish</span> <span class="err">&#39;</span><span class="n">notificationName</span><span class="err">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">check</span> <span class="n">arr</span><span class="p">,</span> <span class="n">Array</span>
    <span class="k">if</span> <span class="n">arr</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">Meteor</span><span class="p">.</span><span class="n">users</span><span class="p">.</span><span class="n">find</span> <span class="p">{</span>
            <span class="nl">_id:</span> 
                <span class="err">$</span><span class="n">in</span><span class="o">:</span> <span class="n">arr</span>
        <span class="p">},</span> <span class="p">{</span>
            <span class="nl">fields:</span>
                <span class="nl">_id:</span> <span class="nb">true</span>
                <span class="err">&#39;</span><span class="n">profile</span><span class="p">.</span><span class="n">name</span><span class="err">&#39;</span><span class="o">:</span> <span class="nb">true</span>
        <span class="p">}</span>
    <span class="k">else</span> 
        <span class="n">this</span><span class="p">.</span><span class="n">ready</span><span class="p">()</span>
</pre></div>


<p>发布通知里面涉及到的人员的名字,有时候你的通知内容涉及到陌生人,是取不到他们名字的,需要通过这个来发布出去</p>
<div class="hlcode"><pre><span class="n">Meteor</span><span class="p">.</span><span class="n">publish</span> <span class="err">&#39;</span><span class="n">group</span><span class="err">&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="n">userId</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">userId</span>
    <span class="k">return</span> <span class="n">DB</span><span class="p">.</span><span class="n">Groups</span><span class="p">.</span><span class="n">find</span> 
        <span class="n">member_list</span><span class="o">:</span> 
            <span class="err">$</span><span class="n">in</span><span class="o">:</span> <span class="p">[</span><span class="n">userId</span><span class="p">]</span>
</pre></div>


<p>发布群组数据,自己所在的群组</p>
<p><strong>这里需要注意,如果要更改订阅,尽量不要在原有基础上做更改,而是多配置一个发布规则去订阅</strong></p>
</div>

        </div>
        <div id="footer">
            <span>
                Copyright © 2012-2014 .
                Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
            </span>
        </div>
        
    </body>
</html>